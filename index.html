<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <title>Калькулятор заказа BK</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>

<!-- ===== ВХОД ===== -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-box">
    <span style="font-size:42px;display:block;margin-bottom:2px;"> <img src="./icons/burger.svg" width="28" height="28" alt=""></span>
    <h2>Калькулятор заказа</h2>
    <p>Введите пароль для входа</p>
    <input id="loginPassword" type="password" placeholder="Пароль" autocomplete="current-password" />
    <button id="loginBtn" class="btn primary">Войти</button>
  </div>
</div>

<header class="header">
<h1 align="center">
  <img
    src="./icons/burger.svg"
    width="28"
    height="28"
    style="vertical-align: -4px;"
    alt=""
  >
  Калькулятор заказа
</h1>
  <nav class="header-menu">
    <button id="menuHistory" class="menu-btn"><img src="./icons/history.svg" width="14" height="14" alt=""> История</button>
    <button id="menuDatabase" class="menu-btn"><img src="./icons/base.svg" width="14" height="14"  alt=""> База данных</button>
    <button id="addManual" class="menu-btn"><img src="./icons/new-product.svg" width="14" height="14" alt=""> Новый товар</button>
    <button id="menuAnalytics" class="menu-btn"><img src="./icons/analytics.svg" width="14" height="14"  alt=""> Аналитика</button>
    <button id="menuPlanning" class="menu-btn"><img src="./icons/planning.svg" width="14" height="14" alt=""> Планирование</button>
    <button id="menuCalendar" class="menu-btn"><img src="./icons/calendar.svg" width="14" height="14" alt=""> Календарь</button>
  </nav>
  <span id="entityBadge" class="entity-badge">Бургер БК</span>
</header>

<main class="container">

  <!-- ===== ПАРАМЕТРЫ ЗАКАЗА ===== -->
  <section class="card">
    <h2>Параметры заказа</h2>

    <div class="settings">
      <label class="tooltip-wrap" data-tip="Юридическое лицо для которого формируется заказ">
        Юр. лицо
        <select id="legalEntity">
          <option value="Бургер БК">Бургер БК</option>
          <option value="Воглия Матта">Воглия Матта</option>
          <option value="Пицца Стар">Пицца Стар</option>
        </select>
      </label>

      <label class="tooltip-wrap" data-tip="Фильтр товаров по поставщику">
        Поставщик
        <select id="supplierFilter">
          <option value="">Все / свободный</option>
        </select>
      </label>

      <label class="tooltip-wrap" data-tip="Дата от которой считается расход товаров">
        Дата сегодня
        <input type="date" id="today" />
      </label>

      <label class="tooltip-wrap" data-tip="Предполагаемая дата поступления товара от поставщика">
        Дата прихода
        <input type="date" id="deliveryDate" />
      </label>

      <label class="tooltip-wrap" data-tip="Количество дней для расчёта среднего дневного расхода">
        Период расхода (дней)
        <input type="number" id="periodDays" value="30" />
      </label>


      <label class="tooltip-wrap" data-tip="Желаемый запас товара на складе после поставки (в днях или дата)">
        Товарный запас
        <div class="safety-input-wrap">
          <input type="text" id="safetyDays" placeholder="14 / до 18.02.26" />
          <button type="button" id="safetyCalendarBtn" class="safety-calendar-icon" title="Выбрать дату окончания запаса">
            <img src="./icons/calendar.svg" width="16" height="16" alt="">
          </button>
        </div>
      </label>
      <label class="tooltip-wrap" data-tip="Единицы измерения для ввода расхода и отображения заказа">
        Единицы
        <select id="unit">
          <option value="pieces">Штуки</option>
          <option value="boxes">Коробки</option>
        </select>
      </label>

      <label class="tooltip-wrap" data-tip="Показывать колонку Транзит (товар в пути) в таблице заказа">
        Наличие транзита
        <select id="hasTransit">
          <option value="false">Нет</option>
          <option value="true">Да</option>
        </select>
      </label>

      <label class="tooltip-wrap" data-tip="Показывать колонку Запас (до какой даты хватит товара) в таблице заказа">
        Отображение запаса
        <select id="showStockColumn">
          <option value="false">Нет</option>
          <option value="true">Да</option>
        </select>
      </label>

      <label class="tooltip-wrap" data-tip="Подсветка расхода, если он отличается от среднего по истории более чем на 25%">
        Проверка данных
        <select id="dataValidation">
          <option value="true">Да</option>
          <option value="false">Нет</option>
        </select>
      </label>
    </div>

    <!-- КЛЮЧЕВАЯ КНОПКА -->
    <button id="buildOrder" class="btn primary">
      <img src="./icons/box.svg" width="18" height="18" style="vertical-align:-3px;" alt=""> Сформировать заказ
    </button>
  </section>

  <!-- ===== ЗАКАЗ (СКРЫТ ДО КНОПКИ) ===== -->
  <div id="orderSection" class="hidden">

    <!-- ТАБЛИЦА ЗАКАЗА -->
    <section class="card">
      <h2>Заказ <span id="itemsCounter" style="font-weight:400;font-size:14px;color:#8B7355;"></span></h2>

      <!-- КОМПАКТНОЕ МЕНЮ -->
      <div class="order-actions" style="display:flex;gap:6px;margin-bottom:12px;font-size:13px;flex-wrap:wrap;align-items:center;">
        <button id="undoBtn" class="btn secondary tooltip-wrap" disabled data-tip="Отменить (Ctrl+Z)" style="padding:4px 8px;">↶</button>
        <button id="redoBtn" class="btn secondary tooltip-wrap" disabled data-tip="Повторить (Ctrl+Y)" style="padding:4px 8px;">↷</button>
        <button id="allToOrderBtn" class="btn primary tooltip-wrap" data-tip="Перенести расчёт в заказ для всех товаров" style="padding:4px 10px;">В заказ всё</button>
        <button id="clearOrder" class="btn primary btn-clear-order tooltip-wrap" data-tip="Удалить все товары из текущего заказа" style="padding:4px 10px;">Очистить</button>
        <button id="copyOrder" class="btn primary tooltip-wrap" data-tip="Скопировать заказ в буфер обмена" style="padding:4px 10px;"><img src="./icons/copy.svg" width="14" height="14" alt="" style="vertical-align:-2px;"> Скопировать</button>
        <button id="saveOrder" class="btn primary tooltip-wrap" data-tip="Сохранить заказ в историю" style="padding:4px 10px;"><img src="./icons/save.svg" width="14" height="14" alt="" style="vertical-align:-2px;"> Сохранить</button>
        <button id="exportExcelBtn" class="btn primary tooltip-wrap" data-tip="Экспортировать заказ в Excel" style="padding:4px 10px;"><img src="./icons/excel.svg" width="14" height="14" alt=""> Excel</button>
        <button id="importStockBtn" class="btn primary tooltip-wrap" data-tip="Импорт остатков из Excel/CSV" style="padding:4px 10px;"><img src="./icons/import.svg" width="14" height="14" alt=""> Импорт</button>
        
        <div style="flex:1;min-width:20px;"></div>
        
        <section class="search" style="max-width:450px;min-width:280px;margin:0;flex:2;">
          <input id="productSearch" placeholder="Поиск товара" />
          <button id="clearSearch" class="search-clear hidden"><img src="./icons/close.svg" width="12" height="12" alt=""></button>
          <div id="searchResults" class="search-results"></div>
        </section>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:30px;"></th>
              <th>Товар</th>
              <th>Расход</th>
              <th>Остаток</th>
              <th class="transit-col">Транзит</th>
              <th class="stock-col">Запас</th>
              <th>Расчёт</th>
              <th>Заказ (шт / кор)</th>
              <th>Хватит до</th>
              <th>Паллеты</th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody id="items"></tbody>
        </table>
      </div>
    </section>

    <!-- ИТОГ -->
    <section class="card">
      <h2>Итог заказа</h2>
      <div id="finalSummary"></div>
    </section>

  </div>


</main>

<!-- ===== МОДАЛКА: ИСТОРИЯ ЗАКАЗОВ ===== -->
<div id="historyModal" class="modal hidden">
  <div class="modal-box large">
    <div class="modal-header">
      <h2><img src="./icons/history.svg" width="16" height="16" alt=""> История</h2>
      <button id="closeHistory" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>

    <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
      <label style="flex:0;min-width:140px;">
        Раздел
        <select id="historyType">
          <option value="orders">Заказы</option>
          <option value="plans">Планирование</option>
        </select>
      </label>
      <label style="flex:1;">
        Юр. лицо
        <select id="historyLegalEntity">
          <option value="">Все</option>
          <option value="Бургер БК">Бургер БК</option>
          <option value="Воглия Матта">Воглия Матта</option>
          <option value="Пицца Стар">Пицца Стар</option>
        </select>
      </label>
      <label style="flex:1;">
        Поставщик
        <select id="historySupplier">
          <option value="">Все</option>
        </select>
      </label>
    </div>

    <div id="orderHistory"></div>
  </div>
</div>


<!-- ===== МОДАЛКА: НОВЫЙ ТОВАР ===== -->
<div id="manualModal" class="modal hidden">
  <div class="modal-box">
    <div class="modal-header">
      <h2><img src="./icons/new-product.svg" width="16" height="16" alt=""> Новый товар</h2>
      <button id="closeManual" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>

    <input id="m_sku" placeholder="Артикул" />
    <input id="m_name" placeholder="Наименование*" />
    <input id="m_supplier" placeholder="Поставщик" />
    
    <label>
      Юр. лицо
      <select id="m_legalEntity">
        <option value="Бургер БК">Бургер БК</option>
        <option value="Воглия Матта">Воглия Матта</option>
        <option value="Пицца Стар">Пицца Стар</option>
      </select>
    </label>
    
    <input id="m_box" type="number" placeholder="Штук в коробке" />
    <input id="m_pallet" type="number" placeholder="Коробов на паллете" />
    
    <label>
      Единица измерения
      <select id="m_unit">
        <option value="шт">штуки</option>
        <option value="л">литры</option>
        <option value="кг">килограммы</option>
      </select>
    </label>

    <label>
      <input type="checkbox" id="m_save" checked />
      Сохранить в базу
    </label>

    <div class="actions">
      <button id="m_add" class="btn primary">Добавить</button>
      <button id="m_cancel" class="btn secondary">Отмена</button>
    </div>
  </div>
</div>

<!-- ===== МОДАЛКА: ПОДТВЕРЖДЕНИЕ ===== -->
<div id="confirmModal" class="modal hidden">
  <div class="modal-box" style="max-width:400px;">
    <div class="modal-header">
      <h2 id="confirmTitle">Подтверждение</h2>
      <button id="closeConfirm" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>
    
    <p id="confirmMessage" style="margin:0 0 24px;color:#5A2D0C;line-height:1.6;"></p>
    
    <div class="actions">
      <button id="confirmYes" class="btn primary">Да</button>
      <button id="confirmNo" class="btn secondary">Отмена</button>
    </div>
  </div>
</div>



<!-- ===== МОДАЛКА: БАЗА ДАННЫХ ===== -->
<div id="databaseModal" class="modal hidden">
  <div class="modal-box large">
    <div class="modal-header">
      <h2><img src="./icons/base.svg" width="20" height="20" style="vertical-align:-3px;" alt=""> База данных <span id="dbCardCount" style="font-weight:400;font-size:14px;color:#8B7355;"></span></h2>
      <button id="closeDatabase" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>

    <label>
      Юр. лицо
      <select id="dbLegalEntity">
        <option value="Бургер БК">Бургер БК</option>
        <option value="Воглия Матта">Воглия Матта</option>
        <option value="Пицца Стар">Пицца Стар</option>
      </select>
    </label>

    <section class="search" style="margin:16px 0;">
      <input id="dbSearch" placeholder="Поиск по карточкам" />
      <button id="clearDbSearch" class="search-clear hidden" title="Очистить"><img src="./icons/close.svg" width="12" height="12" alt=""></button>
    </section>

    <div id="databaseList" style="max-height:60vh;overflow-y:auto;"></div>
  </div>
</div>

<!-- ===== МОДАЛКА: РЕДАКТИРОВАНИЕ КАРТОЧКИ ===== -->
<div id="editCardModal" class="modal hidden">
  <div class="modal-box">
    <div class="modal-header">
      <h2><img src="./icons/edit.svg" width="20" height="20" style="vertical-align:-3px;" alt=""> Редактирование карточки</h2>
      <button id="closeEditCard" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>

    <input id="e_name" placeholder="Наименование*" />
    <input id="e_sku" placeholder="Артикул" />
    <input id="e_supplier" placeholder="Поставщик" />
    
    <label>
      Юр. лицо
      <select id="e_legalEntity">
        <option value="Бургер БК">Бургер БК</option>
        <option value="Воглия Матта">Воглия Матта</option>
        <option value="Пицца Стар">Пицца Стар</option>
      </select>
    </label>
    
    <input id="e_box" type="number" placeholder="Штук в коробке" />
    <input id="e_pallet" type="number" placeholder="Коробок на паллете" />
    
    <label>
      Единица измерения
      <select id="e_unit">
        <option value="шт">штуки</option>
        <option value="л">литры</option>
        <option value="кг">килограммы</option>
      </select>
    </label>

    <div class="actions" style="margin-bottom:0;">
      <button id="e_save" class="btn primary">Сохранить</button>
      <button id="e_cancel" class="btn secondary">Отмена</button>
    </div>
  </div>
</div>



<!-- ===== МОДАЛКА: СОХРАНЕНИЕ ЗАКАЗА ===== -->
<div id="saveOrderModal" class="modal hidden">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-header">
      <h2><img src="./icons/save.svg" width="20" height="20" style="vertical-align:-3px;" alt=""> Сохранить заказ</h2>
      <button id="closeSaveOrder" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>
    
    <p style="margin:0 0 16px;color:#5A2D0C;">Добавьте примечание к заказу (опционально):</p>
    
    <textarea 
      id="orderNote" 
      placeholder="Например: Срочный заказ, Пробная партия, и т.д." 
      style="width:100%;min-height:80px;padding:10px;border:1px solid #E5BE9E;border-radius:4px;font-family:inherit;font-size:14px;resize:vertical;margin-bottom:20px;"
    ></textarea>
    
    <div class="actions" style="margin:0;">
      <button id="confirmSaveOrder" class="btn primary"><img src="./icons/save.svg" width="14" height="14" alt=""> Сохранить</button>
      <button id="cancelSaveOrder" class="btn secondary">Отмена</button>
    </div>
  </div>
</div>
<footer class="footer">
  <span class="version">Версия: <span id="appVersion">0.9.1</span></span>
</footer>

<!-- ===== ПРОВЕРКА АВТОРИЗАЦИИ ===== -->
<script>
// Проверка авторизации ДО загрузки основного скрипта
(function() {
  if (localStorage.getItem('bk_logged_in') === 'true') {
    document.getElementById('loginOverlay').style.display = 'none';
  }
})();
</script>

<script type="module" src="./ui.js?v=0.9.1"></script>

<!-- ===== МОДАЛКА АНАЛИТИКИ ===== -->
<div id="analyticsModal" class="modal hidden">
  <div class="modal-box large" style="width:min(1100px,96vw);padding:24px;">
    <div class="modal-header">
      <h2 style="font-size:20px;"><img src="./icons/analytics.svg" width="16" height="16" alt=""> Аналитика заказов</h2>
      <button id="closeAnalytics" class="modal-close">✕</button>
    </div>
    <!-- Контролы периода -->
    <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fdf9f3;border-radius:8px;margin-bottom:20px;">
      <span style="font-weight:600;color:#5A2D0C;font-size:13px;">ПЕРИОД:</span>
      <select id="analyticsPeriod" style="padding:6px 12px;border-radius:6px;border:1px solid #e8e3db;background:white;font-size:13px;">
        <option value="7">7 дней</option>
        <option value="14">14 дней</option>
        <option value="30" selected>30 дней</option>
        <option value="60">60 дней</option>
        <option value="90">90 дней</option>
      </select>
      <button id="refreshAnalytics" class="btn secondary" style="padding:6px 14px;font-size:13px;"><img src="./icons/update.svg" width="14" height="14" alt=""> Обновить</button>
    </div>
    <!-- Контент аналитики -->
    <div id="analyticsContainer" style="max-height:72vh;overflow-y:auto;padding-right:4px;">
      <div style="text-align:center;padding:60px;color:#999;">
        <div class="loading-spinner"></div>
        <div style="margin-top:14px;">Загрузка данных...</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== МОДАЛКА: КАЛЕНДАРЬ ПОСТАВОК ===== -->
<div id="calendarModal" class="modal hidden">
  <div class="modal-box" style="width:min(720px,96vw);padding:24px;">
    <div class="modal-header">
      <h2 style="font-size:20px;"><img src="./icons/calendar.svg" width="14" height="14" alt=""> Календарь поставок</h2>
      <button id="closeCalendar" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>
    <div id="calendarContainer"></div>
  </div>
</div>

<!-- ===== МОДАЛКА: ПЛАНИРОВАНИЕ ===== -->
<div id="planningModal" class="modal hidden">
  <div class="modal-box large" style="width:min(1400px,98vw);max-width:98vw;padding:24px;">
    <div class="modal-header">
      <h2 style="font-size:20px;"><img src="./icons/planning.svg" width="14" height="14" alt=""> Планирование заказов</h2>
      <button id="closePlanning" class="modal-close"><img src="./icons/close.svg" width="14" height="14" alt=""></button>
    </div>

    <!-- Контролы -->
    <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;padding:14px 16px;background:#fdf9f3;border-radius:8px;margin-bottom:16px;">
      <label style="flex:1;min-width:140px;">
        Юр. лицо
        <select id="planLegalEntity">
          <option value="Бургер БК">Бургер БК</option>
          <option value="Воглия Матта">Воглия Матта</option>
          <option value="Пицца Стар">Пицца Стар</option>
        </select>
      </label>
      <label style="flex:1;min-width:150px;">
        Поставщик
        <select id="planSupplier">
          <option value="">— Выберите поставщика —</option>
        </select>
      </label>
      <label style="flex:0;min-width:100px;">
        Период
        <select id="planMonths">
          <optgroup label="Недели">
            <option value="w1">1 неделя</option>
            <option value="w2">2 недели</option>
            <option value="w3">3 недели</option>
            <option value="w4">4 недели</option>
            <option value="w5">5 недель</option>
            <option value="w6">6 недель</option>
            <option value="w8">8 недель</option>
            <option value="w10">10 недель</option>
            <option value="w12">12 недель</option>
          </optgroup>
          <optgroup label="Месяцы">
            <option value="m1">1 месяц</option>
            <option value="m2">2 месяца</option>
            <option value="m3" selected>3 месяца</option>
          </optgroup>
        </select>
      </label>
      <label style="flex:0;min-width:130px;">
        Дата начала
        <input type="date" id="planStartDate" />
      </label>
      <label style="flex:0;min-width:100px;">
        Ввод в
        <select id="planUnit">
          <option value="pieces">Штуках</option>
          <option value="boxes">Коробках</option>
        </select>
      </label>
    </div>
    <div style="padding:0 16px 10px;">
      <button id="planLoadProducts" class="btn primary" style="height:36px;white-space:nowrap;">Загрузить товары</button>
    </div>

    <!-- Подсказка -->
    <div style="font-size:12px;color:var(--muted);margin-bottom:12px;padding:0 4px;">
      Введите расход за месяц, остатки на складе и у поставщика — система автоматически рассчитает объёмы заказа по месяцам с округлением до коробок.
    </div>

    <!-- Таблица планирования -->
    <div id="planTableContainer" style="max-height:58vh;overflow:auto;">
      <div style="text-align:center;padding:50px;color:var(--muted);">
        <div style="font-size:28px;margin-bottom:8px;"><img src="./icons/planning.svg" width="64" height="64" alt=""></div>
        <div style="font-size:14px;">Выберите поставщика и нажмите «Загрузить товары»</div>
      </div>
    </div>

    <!-- Кнопки действий -->
    <div style="display:flex;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border-light);">
      <button id="planExcelBtn" class="btn secondary" style="background:#217346;color:white;border-color:#1a5c38;"><img src="./icons/excel.svg" width="14" height="14" alt=""> Excel</button>
      <button id="planImportBtn" class="btn secondary"><img src="./icons/import.svg" width="14" height="14" alt=""> Импорт остатков</button>
      <button id="planCopyBtn" class="btn secondary"><img src="./icons/copy.svg" width="14" height="14" alt="" style="vertical-align:-2px;"> Скопировать план</button>
      <button id="planSaveBtn" class="btn primary"><img src="./icons/save.svg" width="14" height="14" alt="" style="vertical-align:-2px;"> Сохранить план</button>
    </div>
  </div>
</div>

</body>
</html>